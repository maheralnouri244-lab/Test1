<!doctype html>
<html>
<head><meta charset="utf-8"><title>Create/Edit Blog</title></head>
<body>
  <h1 id="title">Create Blog</h1>
  <form id="form">
    <label>Title <input name="title" required></label>
    <label>Body <textarea name="body" required></textarea></label>
    <button type="submit">Save</button>
  </form>
  <div id="msg"></div>

  <script type="module">
    import { apiFetch } from './js/api.js';
    import { isAuthenticated, currentUser } from './js/auth.js';

    if (!isAuthenticated()) location.href = 'login.html';

    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    const form = document.getElementById('form');
    const titleEl = document.getElementById('title');

    if (id) {
      titleEl.textContent = 'Edit Blog';
      (async ()=>{
        try {
          const blog = await apiFetch('/blogs/' + id);
          form.title.value = blog.title;
          form.body.value = blog.body;
        } catch (err) {
          document.getElementById('msg').textContent = 'Cannot load blog';
        }
      })();
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = Object.fromEntries(new FormData(form));
      try {
        if (id) {
          await apiFetch('/blogs/' + id, { method: 'PUT', body: payload });
        } else {
          await apiFetch('/blogs', { method: 'POST', body: payload });
        }
        location.href = 'blogs.html';
      } catch (err) {
        document.getElementById('msg').textContent = err.data?.message || 'Save failed';
      }
    });
  </script>
</body>
</html>